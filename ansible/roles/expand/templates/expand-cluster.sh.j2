#!/bin/bash

echo "Begin" > /tmp/minio.log
echo "Killing minio" >> /tmp/minio.log
for pid in $(ps aux | grep "minio" | grep -v grep | grep -v $$ | awk '{print $2}')
do
	sudo kill "${pid}" 2>&1 >> /tmp/minio.log
	echo "Killed ${pid}" >> /tmp/minio.log
done

# Run minio
echo "Running minio" >> /tmp/minio.log
echo "_MINIO_REVERSE_PROXY=1 MINIO_CI_CD=1 MINIO_BROWSER_REDIRECT_URL=\"{{ schema }}://{{ host_prefix }}-0-0.{{ host_domain }}:9090\" MINIO_SERVER_URL=\"{{ schema }}://{{ host_prefix }}-0-0.{{ host_domain }}:9000\" \
github/minio/minio server \
{{ schema }}://{{ host_prefix }}-0-{0...{{ host_count_0-1 }}}.{{ host_domain }}:9000/tmp/data \
{{ schema }}://{{ host_prefix }}-1-{0...{{ host_count_1-1 }}}.{{ host_domain }}:9000/tmp/data \
{{ schema }}://{{ host_prefix }}-2-{0...{{ host_count_2-1 }}}.{{ host_domain }}:9000/tmp/data \
--address :9000 --console-address :9090 --certs-dir $HOME/.minio/certs" >> /tmp/minio.log
# Cluster
_MINIO_REVERSE_PROXY=1 MINIO_CI_CD=1 MINIO_BROWSER_REDIRECT_URL="{{ schema }}://{{ host_prefix }}-0-0.{{ host_domain }}:9090" \
MINIO_SERVER_URL="{{ schema }}://{{ host_prefix }}-0-0.{{ host_domain }}:9000" \
nohup github/minio/minio server \
{{ schema }}://{{ host_prefix }}-0-{0...{{ host_count_0-1 }}}.{{ host_domain }}:9000/tmp/data \
{{ schema }}://{{ host_prefix }}-1-{0...{{ host_count_1-1 }}}.{{ host_domain }}:9000/tmp/data \
{{ schema }}://{{ host_prefix }}-2-{0...{{ host_count_2-1 }}}.{{ host_domain }}:9000/tmp/data \
--address :9000 --console-address :9090 --certs-dir $HOME/.minio/certs >> /tmp/minio.log &

echo "Done" >> /tmp/minio.log
