#!/bin/bash

sudo kill "$(ps aux | grep "minio" | awk '{print $2}')"

wget https://github.com/minio/certgen/releases/latest/download/certgen-linux-amd64
chmod +x certgen-linux-amd64
./certgen-linux-amd64 -host "127.0.0.1,{{ host_list }}"
mkdir -p $HOME/.minio/certs/CAs
cp public.crt $HOME/.minio/certs
cp private.key $HOME/.minio/certs

# Add entry to hosts
sudo tee /etc/hosts << EOF
127.0.0.1 HOSTNAME
EOF

# Install go
cd $HOME && mkdir go && cd go && wget https://go.dev/dl/go1.21.3.linux-amd64.tar.gz && sudo rm -rf /usr/local/go && sudo tar -C /usr/local -xzf go1.21.3.linux-amd64.tar.gz
/usr/local/go/bin/go version

# Install modified minio
sudo apt install git
cd $HOME && mkdir github && cd github && git clone {{ minio_repo }} && cd minio && git checkout {{ minio_branch }}
CGO_ENABLED=0 /usr/local/go/bin/go build -tags kqueue -trimpath -o minio

# Run minio
MINIO_IS_LXC=1 MINIO_CI_CD=1 \
./minio server \
{{ schema }}://{{ host_prefix }}{0...{{ host_count }}}.{{ host_domain }}:9000/tmp/data{1...2} \
--address :9000 --console-address :9090 --certs-dir $HOME/.minio/certs &